# MCP サーバーコードの説明

## 1. 目的と機能

`server.ts`は、Model Context Protocol (MCP) サーバーを実装するコードです。MCP
は、大規模言語モデル（LLM）がローカルのツールやリソースにアクセスするための標準プロトコルです。このサーバーは具体的に以下の機能を提供します：

- **ツールの提供**:
  `getStringLength`という文字列の長さを計算するツールを提供します
- **JSONRPC ベースの通信**:
  クライアント（LLM）からのリクエストを受け取り、適切なレスポンスを返します
- **標準入出力（stdio）を使用した通信**:
  標準入出力を通じてクライアントと通信します

このサーバーは、Roo Cline
などのクライアントから呼び出されると、文字列の長さを計算するサービスを提供します。特に、絵文字や結合文字を含む文字列の長さを正確に計算できるように実装されています。

## 2. 主要コンポーネントとその相互作用

### 主要コンポーネント

1. **インポート部分（1-14 行目）**:

   ```typescript
   import { Server } from "npm:@modelcontextprotocol/sdk@1.5.0/server/index.js";
   import { StdioServerTransport } from "npm:@modelcontextprotocol/sdk@1.5.0/server/stdio.js";
   import { ... } from "npm:@modelcontextprotocol/sdk@1.5.0/types.js";
   ```

   - MCP SDK からサーバー関連のクラスと型をインポートしています
   - `npm:`プレフィックスは、Deno で npm
     パッケージを使用するための特殊な構文です

2. **ツール定義（16-28 行目）**:

   ```typescript
   const TOOLS: Tool[] = [
     {
       name: "getStringLength",
       description: "Get the length of a string",
       inputSchema: { ... }
     }
   ];
   ```

   - サーバーが提供するツールを定義しています
   - 各ツールには名前、説明、入力スキーマが含まれます

3. **サーバー初期化（29-42 行目）**:

   ```typescript
   const server = new Server(
     { name: "local", version: "0.1.0" },
     { capabilities: { resources: {}, tools: { getStringLength: TOOLS[0] } } },
   );
   ```

   - MCP サーバーのインスタンスを作成し、名前、バージョン、機能を設定しています

4. **リクエストハンドラー（44-99 行目）**:

   - `ListResourcesRequestSchema`:
     リソース一覧のリクエストを処理します（空のリストを返す）
   - `ListToolsRequestSchema`:
     ツール一覧のリクエストを処理します（定義したツールのリストを返す）
   - `CallToolRequestSchema`:
     ツール実行のリクエストを処理します（文字列の長さを計算して返す）

5. **エラーハンドリングとシグナル処理（101-111 行目）**:

   - サーバーのエラーハンドラーを設定
   - SIGINT シグナル（Ctrl+C）を受け取った際の処理を定義

6. **サーバー起動（113-117 行目）**:
   ```typescript
   await server.connect(new StdioServerTransport());
   ```
   - StdioServerTransport
     を使用してサーバーを起動し、標準入出力を通じて通信を行います

### コンポーネント間の相互作用

1. **クライアントからのリクエスト受信**:

   - クライアント（LLM）からのリクエストは標準入力を通じてサーバーに送信されます
   - `StdioServerTransport`がこれらのリクエストを受け取り、JSONRPC
     メッセージとしてパースします

2. **リクエスト処理**:

   - サーバーは受け取ったリクエストのタイプに基づいて、適切なハンドラーを呼び出します
   - 例えば、ツール実行リクエストの場合、`CallToolRequestSchema`ハンドラーが呼び出されます

3. **ツール実行**:

   - ハンドラー内でリクエストパラメータを検証し、ツール名に基づいて適切な処理を実行します
   - `getStringLength`ツールの場合、入力文字列の長さを計算します

4. **レスポンス送信**:
   - 処理結果を JSONRPC レスポンスとして標準出力に送信します
   - エラーが発生した場合は、適切なエラーレスポンスを返します

## 3. 重要なパターンや使用されている技術

### 使用されている技術

1. **Deno**: Node.js の代替となる最新の JavaScript/TypeScript ランタイム

   - 安全性を重視し、明示的な権限が必要（`--allow-net`, `--allow-env`など）
   - npm パッケージを直接使用可能（`npm:`プレフィックス）

2. **MCP SDK**: Model Context Protocol を実装するためのライブラリ

   - サーバーの作成と設定を簡素化
   - リクエスト/レスポンスの型定義を提供
   - エラーハンドリングの仕組みを提供

3. **JSONRPC**: クライアント-サーバー間の通信プロトコル

   - リクエストとレスポンスの標準形式を定義
   - メソッド名とパラメータを使用した呼び出し

4. **標準入出力（stdio）**: プロセス間通信の基本的な方法
   - 親プロセス（LLM）と子プロセス（MCP サーバー）間の通信に使用
   - テキストベースの通信を可能にする

### 重要なパターン

1. **リクエストハンドラーパターン**:

   - 各リクエストタイプに対して専用のハンドラー関数を登録
   - `server.setRequestHandler(SchemaType, handlerFunction)`の形式で実装

2. **エラーハンドリングパターン**:

   - try-catch ブロックを使用して例外を捕捉
   - 専用のエラークラス（`McpError`）を使用して型付きエラーを生成
   - エラーコードとメッセージを含むエラーレスポンスを返す

3. **シグナルハンドリングパターン**:

   - OS シグナル（SIGINT）をリッスンしてクリーンアップ処理を実行
   - サーバーの適切なシャットダウンを保証

4. **スキーマ検証パターン**:
   - 入力パラメータの型と存在を検証
   - 無効な入力に対して適切なエラーを返す

### 特筆すべき実装詳細

1. **文字列長さの正確な計算**:

   ```typescript
   const length = Array.from(input).length;
   ```

   - `Array.from()`を使用して文字列をコードポイントの配列に変換
   - これにより、絵文字や結合文字を含む文字列の長さを正確に計算可能

2. **型安全なエラーハンドリング**:

   ```typescript
   if (error instanceof McpError) {
     throw error;
   }
   ```

   - MCP プロトコル固有のエラーと一般的なエラーを区別
   - プロトコルエラーはそのまま伝播し、一般エラーはカスタムレスポンスに変換

3. **非同期処理**:
   - `async/await`構文を使用して非同期操作を簡潔に記述
   - サーバー接続やシャットダウン処理を非同期で実行

## まとめ

このコードは、Deno を使用して MCP
サーバーを実装し、文字列の長さを計算するツールを提供しています。MCP
プロトコルに準拠した JSONRPC
通信を使用し、標準入出力を通じてクライアントと通信します。エラーハンドリングやシグナル処理も適切に実装されており、堅牢なサーバーとなっています。

このサーバーは、Roo Cline
などのクライアントから呼び出されると、文字列の長さを正確に計算するサービスを提供します。特に、絵文字や結合文字を含む文字列の長さを正確に計算できる点が特徴です。
